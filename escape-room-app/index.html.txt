<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CDC Escape Room</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
  <div id="root"></div>
  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode"></script>

  <script type="text/babel">
    // Paste the React code from the 'escape-room-app' immersive here.
    const puzzles = {
      1: {
        answer: 'QUARANTINE',
        nextClue: 'Great! You have successfully accessed the main system. The next clue is hidden in the biosafety cabinet. Look for a combination lock. The combination is the last 4 digits of the patient ID for patient zero. The patient ID is in the "Patient Records" file on the admin desk.',
      },
      2: {
        answer: '5934',
        nextClue: 'You are making great progress! Now that you have the key, you can access the specimen storage. The final puzzle awaits you there. The antidote is stored in a container labeled "Project Chimera". The code to open the container is a 3-letter sequence from the virus\'s genetic code, found in the lab notes.',
      },
      3: {
        answer: 'TGA',
        nextClue: 'Congratulations, agent! You have successfully synthesized the antidote and saved the world from the Crimson Scourge. Evacuate the facility immediately. You win!',
      },
    };

    const initialPlayerState = {
      'player-1': { currentPuzzle: 1, puzzlesSolved: [] },
      'player-2': { currentPuzzle: 1, puzzlesSolved: [] },
    };

    const App = () => {
      const [scannedUserId, setScannedUserId] = useState(null);
      const [puzzleInput, setPuzzleInput] = useState('');
      const [feedback, setFeedback] = useState({ message: '', type: '' });
      const [appState, setAppState] = useState(initialPlayerState);

      useEffect(() => {
        if (!scannedUserId) {
          const html5QrCodeScanner = new Html5QrcodeScanner(
            "reader",
            { fps: 10, qrbox: { width: 250, height: 250 } },
            false
          );

          const onScanSuccess = (decodedText, decodedResult) => {
            console.log(`Code scanned: ${decodedText}`);
            setScannedUserId(decodedText);
            html5QrCodeScanner.clear();
          };

          const onScanError = (errorMessage) => {
            console.error('Scan error:', errorMessage);
          };

          html5QrCodeScanner.render(onScanSuccess, onScanError);
        }
      }, [scannedUserId]);

      const handleAnswerSubmit = (e) => {
        e.preventDefault();
        if (!scannedUserId) {
          setFeedback({ message: 'Please scan your ID first!', type: 'error' });
          return;
        }

        const currentPlayer = appState[scannedUserId];
        const currentPuzzle = puzzles[currentPlayer.currentPuzzle];
        
        if (puzzleInput.toUpperCase() === currentPuzzle.answer.toUpperCase()) {
          const newAppState = { ...appState };
          newAppState[scannedUserId].puzzlesSolved.push(currentPlayer.currentPuzzle);
          newAppState[scannedUserId].currentPuzzle += 1;
          setAppState(newAppState);
          
          setFeedback({ message: currentPuzzle.nextClue, type: 'success' });
          setPuzzleInput('');
        } else {
          setFeedback({ message: 'Incorrect answer. Please try again.', type: 'error' });
        }
      };

      const handleReset = () => {
        setScannedUserId(null);
        setPuzzleInput('');
        setFeedback({ message: '', type: '' });
      };

      return (
        <div className="min-h-screen bg-gray-950 text-white flex flex-col items-center justify-center p-4 font-sans antialiased">
          <div className="w-full max-w-2xl bg-gray-900 rounded-2xl shadow-xl p-8 space-y-8 border border-gray-700">
            <header className="text-center">
              <h1 className="text-4xl font-bold text-red-500 tracking-wider mb-2">CDC ALERT</h1>
              <p className="text-xl text-gray-300">Operation: Antidote</p>
            </header>

            {scannedUserId ? (
              <>
                <h2 className="text-2xl font-semibold text-center text-gray-100">
                  Agent ID: <span className="text-red-400">{scannedUserId.toUpperCase()}</span>
                </h2>
                <div className="bg-gray-800 p-6 rounded-xl border border-gray-700 space-y-4">
                  <p className="text-lg text-gray-200">
                    You are currently on Puzzle {appState[scannedUserId]?.currentPuzzle}.
                  </p>
                  
                  {feedback.message && (
                    <div 
                      className={`p-4 rounded-lg text-sm transition-all duration-300 ease-in-out ${
                        feedback.type === 'success' ? 'bg-green-700 text-white shadow-lg' : 'bg-red-700 text-white shadow-lg'
                      }`}
                    >
                      <p>{feedback.message}</p>
                    </div>
                  )}

                  {appState[scannedUserId]?.currentPuzzle <= Object.keys(puzzles).length && (
                    <form onSubmit={handleAnswerSubmit} className="space-y-4">
                      <div>
                        <label htmlFor="puzzle-input" className="block text-gray-400 mb-2">
                          Enter the solution to the puzzle:
                        </label>
                        <input
                          id="puzzle-input"
                          type="text"
                          value={puzzleInput}
                          onChange={(e) => setPuzzleInput(e.target.value)}
                          className="w-full p-3 rounded-lg bg-gray-700 border border-gray-600 text-white placeholder-gray-400 focus:ring-red-500 focus:border-red-500"
                          placeholder="Enter your answer here..."
                          required
                        />
                      </div>
                      <button
                        type="submit"
                        className="w-full p-3 rounded-lg bg-red-600 text-white font-bold text-lg hover:bg-red-700 transition-colors duration-300 shadow-md"
                      >
                        Submit Answer
                      </button>
                    </form>
                  )}
                </div>
                <button
                  onClick={handleReset}
                  className="w-full p-3 rounded-lg bg-gray-700 text-gray-300 font-bold hover:bg-gray-600 transition-colors duration-300"
                >
                  Scan a Different ID
                </button>
              </>
            ) : (
              <>
                <h2 className="text-2xl font-semibold text-center text-gray-100">
                  Scan Your Agent ID Card to Begin
                </h2>
                <div className="w-full flex justify-center">
                  <div id="reader" className="w-full max-w-sm"></div>
                </div>
              </>
            )}
          </div>
          <div className="mt-8 text-center text-sm text-gray-500">
            <a href="https://github.com/mebjas/html5-qrcode" target="_blank" rel="noopener noreferrer" className="hover:underline">
              Powered by html5-qrcode
            </a>
          </div>
        </div>
      );
    };

    const rootElement = document.getElementById('root');
    ReactDOM.createRoot(rootElement).render(React.createElement(App));
  </script>
</body>
</html>
